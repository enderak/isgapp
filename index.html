<!DOCTYPE html>
<html lang="tr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob:;">
    
    <title>Ä°SG SÄ±navmatik</title>
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XNTGQBXZ3Y"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XNTGQBXZ3Y');
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {"50":"#eff6ff","100":"#dbeafe","200":"#bfdbfe","300":"#93c5fd","400":"#60a5fa","500":"#3b82f6","600":"#2563eb","700":"#1d4ed8","800":"#1e40af","900":"#1e3a8a"}
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; position: fixed; top: 0; left: 0; right: 0; bottom: 0; height: 100dvh; overflow: hidden; user-select: none; }
        .scroller { -webkit-overflow-scrolling: touch; }
        .scroller::-webkit-scrollbar { width: 3px; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .scroller::-webkit-scrollbar-thumb { background: #334155; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px); }
        .text-size-0 { font-size: 0.875rem; } 
        .text-size-1 { font-size: 1rem; }    
        .text-size-2 { font-size: 1.125rem; } 
        .text-size-3 { font-size: 1.25rem; }  
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300">

    <div id="app" class="flex flex-col h-full w-full max-w-md mx-auto bg-white dark:bg-slate-900 shadow-2xl relative transition-colors duration-300 border-x border-slate-200 dark:border-slate-800">
        <div class="flex items-center justify-center h-full">
            <div class="flex flex-col items-center animate-pulse">
                <i data-lucide="loader-2" class="w-10 h-10 text-primary-600 animate-spin mb-3"></i>
                <div class="text-sm font-medium text-slate-400">SÄ±navmatik YÃ¼kleniyor...</div>
            </div>
        </div>
    </div>

    <div id="imageModal" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay p-4" onclick="closeImageModal()">
        <div class="relative max-w-4xl w-full max-h-full flex justify-center">
            <button class="absolute -top-10 right-0 text-white hover:text-red-400 p-2" onclick="closeImageModal()">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
            <img id="modalImage" src="" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl object-contain bg-white">
        </div>
    </div>

    <div id="reportModal" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay p-4">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm p-6 fade-in border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-red-600 dark:text-red-400 flex items-center gap-2">
                    <i data-lucide="alert-triangle" class="w-5 h-5"></i> Hata Bildir
                </h3>
                <button onclick="closeReportModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="text-xs text-slate-500 dark:text-slate-400 mb-4 bg-slate-50 dark:bg-slate-900 p-3 rounded-lg border border-slate-100 dark:border-slate-700">
                <p><strong>Kaynak:</strong> <span id="reportSource">...</span></p>
                <p class="truncate mt-1"><strong>Soru:</strong> <span id="reportQText">...</span></p>
            </div>

            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Hata nedir?</label>
            <textarea id="reportMessage" rows="3" class="w-full p-3 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-900 text-sm focus:ring-2 focus:ring-red-500 outline-none mb-4" placeholder="Ã–rn: Cevap A ÅŸÄ±kkÄ± olmalÄ±, soruda yazÄ±m hatasÄ± var vb."></textarea>

            <button onclick="sendReportEmail()" class="w-full py-3 rounded-xl bg-red-600 hover:bg-red-700 text-white font-bold text-sm shadow transition-colors flex items-center justify-center gap-2">
                <i data-lucide="send" class="w-4 h-4"></i> Bildirimi E-Posta ile GÃ¶nder
            </button>
        </div>
    </div>

    <script>window.SoruHavuzu = window.SoruHavuzu || [];</script>
    
    <script src="sorular/2024-2-C.js" onerror="console.log('2024-2-C yok')"></script>
    <script src="sorular/2025-1-A.js" onerror="console.log('2025-1-A yok')"></script>
    <script src="sorular/2025-1-B.js" onerror="console.log('2025-1-B yok')"></script>
    <script src="sorular/2025-1-C.js" onerror="console.log('2025-1-C yok')"></script>
    
    <script src="sorular/Deneme-2024-2-C.js" onerror="console.log('Deneme 2024-2-C yok')"></script>
    <script src="sorular/Deneme-2025-1-A.js" onerror="console.log('Deneme 2025-1-A yok')"></script>
    <script src="sorular/Deneme-2025-1-B.js" onerror="console.log('Deneme 2025-1-B yok')"></script>
    <script src="sorular/Deneme-2025-1-C.js" onerror="console.log('Deneme 2025-1-C yok')"></script>

    <script>
        // --- DÃœZELTÄ°LMÄ°Åž E-POSTA ADRESÄ° ---
        const ADMIN_EMAIL = "isgapp@proton.me"; 
        // ----------------------------------

        if (window.SoruHavuzu.length === 0) {
            window.SoruHavuzu.push({
                category: "Sistem", text: "UyarÄ±: HiÃ§bir soru dosyasÄ± yÃ¼klenemedi. LÃ¼tfen 'sorular' klasÃ¶rÃ¼nÃ¼ kontrol edin.", options: ["Tamam"], correct: 0, source: "SÄ°STEM", explanation: "Dosya yolu hatasÄ±.", profile: "ortak"
            });
        }

        const CONFIG = {
            'isg_a': { label: 'Ä°SG (A SÄ±nÄ±fÄ±)', color: 'red' },
            'isg_b': { label: 'Ä°SG (B SÄ±nÄ±fÄ±)', color: 'orange' },
            'isg_c': { label: 'Ä°SG (C SÄ±nÄ±fÄ±)', color: 'blue' },
            'hekim': { label: 'Ä°ÅŸyeri HekimliÄŸi', color: 'emerald' },
            'dsp': { label: 'DiÄŸer SaÄŸlÄ±k P.', color: 'purple' }
        };

        const STANDARD_DISTRIBUTION = { 'Teknik': 20, 'Mevzuat': 15, 'Genel Ä°SG KonularÄ±': 7, 'SaÄŸlÄ±k': 5, 'Hukuk': 3 };
        
        const RANKS = [
            { min: 0, title: "Ã‡Ä±rak", icon: "user", color: "gray" },
            { min: 100, title: "Kalfa", icon: "hammer", color: "blue" },
            { min: 500, title: "Usta", icon: "award", color: "orange" },
            { min: 1000, title: "Uzman", icon: "shield-check", color: "red" },
            { min: 2000, title: "BaÅŸuzman", icon: "crown", color: "purple" }
        ];

        let app = document.getElementById('app');
        let currentScreen = 'start';
        let currentQuestions = [];
        let userAnswers = {};
        
        let favoriteIDs;
        try {
            favoriteIDs = new Set(JSON.parse(localStorage.getItem('isg_favs') || '[]'));
        } catch(e) { favoriteIDs = new Set(); }

        let totalCorrectAllTime = parseInt(localStorage.getItem('isg_total_correct') || '0');
        let currentIndex = 0;
        let timerInterval;
        let timeRemaining = 0;
        let isTimerActive = true;
        let isEduMode = false;
        let isReviewMode = false;
        let activeProfile = 'isg_c'; 
        let touchStartX = 0;
        let fontLevel = 1; 

        // Geri tuÅŸu kontrolÃ¼
        window.addEventListener('popstate', (e) => {
            if (currentScreen === 'quiz' && !isReviewMode) {
                if (confirm('SÄ±navdan Ã§Ä±kmak istediÄŸinize emin misiniz? Ä°lerlemeniz kaybolacak.')) {
                    renderStartScreen();
                } else {
                    history.pushState(null, null, window.location.pathname);
                }
            }
        });

        function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            renderCurrentScreen();
        }
        function renderCurrentScreen() {
            if(currentScreen === 'start') renderStartScreen();
            else if(currentScreen === 'quiz') renderQuiz();
            else if(currentScreen === 'result') finishQuiz();
        }
        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').classList.add('flex');
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').classList.remove('flex');
        }

        // --- HATA BÄ°LDÄ°RÄ°M FONKSÄ°YONLARI ---
        function openReportModal() {
            if (!currentQuestions[currentIndex]) return;
            const q = currentQuestions[currentIndex];
            
            document.getElementById('reportSource').innerText = q.source || "Bilinmiyor";
            document.getElementById('reportQText').innerText = q.text.substring(0, 50) + "...";
            document.getElementById('reportMessage').value = ""; 
            
            document.getElementById('reportModal').classList.remove('hidden');
            document.getElementById('reportModal').classList.add('flex');
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
            document.getElementById('reportModal').classList.remove('flex');
        }

        function sendReportEmail() {
            const q = currentQuestions[currentIndex];
            const msg = document.getElementById('reportMessage').value;
            
            if(!msg) { alert("LÃ¼tfen hata aÃ§Ä±klamasÄ±nÄ± yazÄ±nÄ±z."); return; }

            const subject = encodeURIComponent(`Ä°SG Hata Bildirimi: ${q.source}`);
            const body = encodeURIComponent(
                `Merhaba,\n\nAÅŸaÄŸÄ±daki soruda bir hata olduÄŸunu dÃ¼ÅŸÃ¼nÃ¼yorum:\n\n` +
                `--------------------------------\n` +
                `KAYNAK: ${q.source}\n` +
                `KATEGORÄ°: ${q.category}\n` +
                `SORU METNÄ°: ${q.text}\n` + 
                `--------------------------------\n\n` +
                `HATA AÃ‡IKLAMASI:\n${msg}\n\n`
            );

            window.location.href = `mailto:${ADMIN_EMAIL}?subject=${subject}&body=${body}`;
            closeReportModal();
        }

        function shareResult(score, correct, wrong) {
            const text = `Ä°SG SÄ±navmatik'te ${activeProfile.toUpperCase().replace('_',' ')} seviyesinde bir denemeyi bitirdim!\n\nPuan: ${score}\nDoÄŸru: ${correct}\nYanlÄ±ÅŸ: ${wrong}\n\nSen de Ã§Ã¶z: https://isgapp.vercel.app`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Ä°SG SÄ±nav Sonucum',
                    text: text,
                    url: 'https://isgapp.vercel.app',
                }).catch(console.error);
            } else {
                const tempInput = document.createElement("textarea");
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                alert("SonuÃ§ panoya kopyalandÄ±! WhatsApp'ta paylaÅŸabilirsin.");
            }
        }

        document.addEventListener('keydown', (e) => {
            if (currentScreen !== 'quiz') return;
            if (e.key >= '1' && e.key <= '5') selectAnswer(parseInt(e.key) - 1);
            if (e.key === 'ArrowRight') nextQ();
            if (e.key === 'ArrowLeft') prevQ();
            if (e.key.toLowerCase() === 'm') toggleBookmark();
            if (e.key === 'Escape') { closeImageModal(); closeReportModal(); }
        });

        // --- EKRAN: BAÅžLANGIÃ‡ ---
        function renderStartScreen() {
            currentScreen = 'start';
            isReviewMode = false;
            
            history.pushState(null, null, window.location.pathname);
            
            setTimeout(() => { 
                lucide.createIcons();
                updateSourceList(); 
            }, 0);

            const totalQ = window.SoruHavuzu.length;
            const historyData = JSON.parse(localStorage.getItem('examHistory')) || [];
            const favCount = favoriteIDs.size;

            // RÃ¼tbe HesabÄ±
            let currentRank = RANKS[0];
            let nextRank = null;
            for(let i = 0; i < RANKS.length; i++) {
                if(totalCorrectAllTime >= RANKS[i].min) {
                    currentRank = RANKS[i];
                    nextRank = RANKS[i+1] || null;
                }
            }
            
            let progressPercent = 100;
            let progressText = "Maksimum Seviye";
            if (nextRank) {
                const diff = nextRank.min - currentRank.min;
                const current = totalCorrectAllTime - currentRank.min;
                progressPercent = Math.min(100, (current / diff) * 100);
                progressText = `${nextRank.title} iÃ§in ${nextRank.min - totalCorrectAllTime} doÄŸru kaldÄ±`;
            }

            const lastExams = historyData.slice(0, 3).map(h => `
                <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-800 mb-2 text-xs">
                    <div>
                        <div class="font-bold text-slate-700 dark:text-slate-200">${h.date}</div>
                        <div class="text-slate-400 flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full ${h.profileColor ? 'bg-'+h.profileColor+'-500' : 'bg-slate-400'}"></span>
                            ${h.profileLabel || 'Genel'}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold ${h.score >= 70 ? 'text-green-600' : 'text-red-500'} text-lg">${h.score}</div>
                    </div>
                </div>
            `).join('') || '<div class="text-xs text-slate-400 text-center py-4">HenÃ¼z sÄ±nav geÃ§miÅŸi yok.</div>';

            const categories = [...new Set(window.SoruHavuzu.map(q => q.category))].sort();
            let catOpts = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            
            const profileOptions = Object.keys(CONFIG).map(key => 
                `<option value="${key}" ${activeProfile === key ? 'selected' : ''}>${CONFIG[key].label}</option>`
            ).join('');

            app.innerHTML = `
                <div class="flex flex-col h-full bg-white dark:bg-slate-900 transition-colors">
                    <div class="p-5 flex justify-between items-center border-b border-slate-100 dark:border-slate-800">
                        <div>
                            <h1 class="text-2xl font-black text-slate-800 dark:text-white tracking-tight">Ä°SG <span class="text-primary-600">SINAVMATÄ°K</span></h1>
                        </div>
                        <button onclick="toggleTheme()" class="p-2.5 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
                            <i data-lucide="${document.documentElement.classList.contains('dark') ? 'sun' : 'moon'}" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-5 scroller space-y-6">
                        
                        <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4 shadow-sm relative overflow-hidden">
                            <div class="flex items-center gap-4 relative z-10">
                                <div class="w-12 h-12 rounded-full bg-${currentRank.color}-100 dark:bg-${currentRank.color}-900/30 flex items-center justify-center text-${currentRank.color}-600 dark:text-${currentRank.color}-400">
                                    <i data-lucide="${currentRank.icon}" class="w-6 h-6"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-slate-400 uppercase font-bold">Mevcut Seviye</div>
                                    <div class="text-lg font-black text-slate-800 dark:text-white">${currentRank.title}</div>
                                    <div class="text-[10px] text-slate-500 mt-0.5">Toplam ${totalCorrectAllTime} DoÄŸru</div>
                                </div>
                            </div>
                            <div class="mt-3 w-full bg-slate-100 dark:bg-slate-700 rounded-full h-1.5 overflow-hidden">
                                <div class="bg-${currentRank.color}-500 h-full rounded-full transition-all duration-1000" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="text-[9px] text-right text-slate-400 mt-1">${progressText}</div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative overflow-hidden rounded-xl bg-gradient-to-br from-primary-600 to-primary-800 p-4 text-white shadow-lg shadow-primary-200 dark:shadow-none">
                                <div class="relative z-10">
                                    <div class="text-primary-100 text-[10px] font-medium mb-1 uppercase tracking-wider">Soru Havuzu</div>
                                    <div class="text-2xl font-black">${totalQ}</div>
                                </div>
                                <div class="absolute bottom-2 right-2 opacity-20"><i data-lucide="database" class="w-8 h-8"></i></div>
                            </div>
                            
                            <div onclick="startFavoritesQuiz()" class="relative overflow-hidden rounded-xl bg-gradient-to-br from-yellow-500 to-yellow-600 p-4 text-white shadow-lg shadow-yellow-200 dark:shadow-none cursor-pointer hover:scale-95 transition-transform">
                                <div class="relative z-10">
                                    <div class="text-yellow-100 text-[10px] font-medium mb-1 uppercase tracking-wider">Favori Sorular</div>
                                    <div class="text-2xl font-black">${favCount}</div>
                                </div>
                                <div class="absolute bottom-2 right-2 opacity-20"><i data-lucide="star" class="w-8 h-8"></i></div>
                                ${favCount > 0 ? '<div class="absolute bottom-3 right-12 text-[10px] bg-white/20 px-2 py-0.5 rounded">Ã‡Ã¶z</div>' : ''}
                            </div>
                        </div>

                        <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4 space-y-4 shadow-sm">
                            <h3 class="text-sm font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                <i data-lucide="settings-2" class="w-4 h-4 text-slate-400"></i> SÄ±navÄ± YapÄ±landÄ±r
                            </h3>
                            
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">SÄ±nav Grubu</label>
                                    <select id="profileSelect" onchange="updateSourceList()" class="w-full mt-1 p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-bold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-primary-500 outline-none appearance-none">
                                        ${profileOptions}
                                    </select>
                                </div>

                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Kaynak SeÃ§imi</label>
                                    <select id="sourceSelect" class="w-full mt-1 p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-primary-500 outline-none appearance-none">
                                        </select>
                                </div>

                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Konu Filtresi</label>
                                    <select id="categorySelect" class="w-full mt-1 p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-primary-500 outline-none appearance-none">
                                        <option value="TUMU">ðŸ“š TÃ¼m Konular</option>
                                        ${catOpts}
                                    </select>
                                </div>
                            </div>

                            <div class="flex items-center justify-between pt-2 border-t border-slate-100 dark:border-slate-700/50">
                                <div class="flex items-center gap-2">
                                    <div class="p-1.5 bg-indigo-50 dark:bg-indigo-900/30 rounded text-indigo-600 dark:text-indigo-400">
                                        <i data-lucide="graduation-cap" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-slate-700 dark:text-slate-200">EÄŸitim Modu</div>
                                        <div class="text-[10px] text-slate-400">CevabÄ± anÄ±nda gÃ¶ster</div>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="eduToggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                </label>
                            </div>
                            
                            <button onclick="startCustomQuiz()" class="w-full py-3.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold text-sm shadow-lg hover:shadow-xl hover:translate-y-[-2px] transition-all flex items-center justify-center gap-2">
                                SÄ±navÄ± BaÅŸlat <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                    <i data-lucide="history" class="w-4 h-4 text-slate-400"></i> Son SÄ±navlar
                                </h3>
                                <button onclick="clearHistory()" class="text-[10px] text-red-400 hover:text-red-600 hover:underline">GeÃ§miÅŸi Temizle</button>
                            </div>
                            ${lastExams}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- YENÄ° FONKSÄ°YON: AkÄ±llÄ± Kaynak Listesi ---
        function updateSourceList() {
            activeProfile = document.getElementById('profileSelect').value;
            const profile = activeProfile;
            const select = document.getElementById('sourceSelect');
            
            const allSources = [...new Set(window.SoruHavuzu.map(q => q.source))].sort().reverse();
            const isISG = ['isg_a', 'isg_b', 'isg_c'].includes(profile);

            const filteredSources = allSources.filter(sourceName => {
                const sampleQ = window.SoruHavuzu.find(q => q.source === sourceName);
                if (!sampleQ) return false;
                if (sampleQ.profile === 'ortak' || sampleQ.profile === 'igu') return true;
                if (sampleQ.profile === profile) return true;
                if (isISG && sampleQ.profile === 'igu') return true;
                return false;
            });

            let html = `
                <option value="KARMA_DENEME" class="font-bold text-indigo-600">ðŸŽ² Karma Deneme (50 Soru)</option>
                <option value="KARMA_CIKMIS" class="font-bold text-rose-600">ðŸ“… Karma Ã‡Ä±kmÄ±ÅŸ Sorular (50 Soru)</option>
                <option disabled class="text-slate-300">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>
            `;

            filteredSources.forEach(s => {
                html += `<option value="${s}">${s}</option>`;
            });

            if (filteredSources.length === 0) {
                html += `<option disabled>Bu profile uygun kaynak yok</option>`;
            }

            select.innerHTML = html;
        }

        function clearHistory() {
            if(confirm("SÄ±nav geÃ§miÅŸini silmek istiyor musun?")) {
                localStorage.removeItem('examHistory');
                renderStartScreen();
            }
        }

        function startCustomQuiz() {
            activeProfile = document.getElementById('profileSelect').value;
            const source = document.getElementById('sourceSelect').value;
            const category = document.getElementById('categorySelect').value;
            
            isEduMode = document.getElementById('eduToggle').checked;
            isTimerActive = !isEduMode;
            timeRemaining = 75 * 60;
            
            prepareQuizQuestions(source, activeProfile, category, 50);
        }

        function startFavoritesQuiz() {
            if(favoriteIDs.size === 0) { alert("HenÃ¼z favori sorunuz yok. SÄ±nav esnasÄ±nda bayrak ikonuna tÄ±klayarak ekleyebilirsiniz."); return; }
            currentQuestions = window.SoruHavuzu.filter(q => favoriteIDs.has(q.text));
            if(currentQuestions.length === 0) { alert("Favori sorular yÃ¼klenemedi."); return; }
            currentQuestions.sort(() => Math.random() - 0.5);
            isEduMode = true; 
            isTimerActive = false;
            activeProfile = 'favoriler'; 
            userAnswers = {};
            currentIndex = 0;
            renderQuiz();
        }

        function prepareQuizQuestions(source, profile, category, count) {
            currentQuestions = [];
            let pool = window.SoruHavuzu;
            const isISG = ['isg_a', 'isg_b', 'isg_c'].includes(profile);

            let filteredPool = pool.filter(q => {
                if (q.profile === 'ortak' || !q.profile) return true;
                if (q.profile === profile) return true;
                if (isISG && q.profile === 'igu') return true;
                return false;
            });

            if (source === 'KARMA_DENEME') {
                filteredPool = filteredPool.filter(q => q.source.includes('Deneme'));
            } else if (source === 'KARMA_CIKMIS') {
                filteredPool = filteredPool.filter(q => !q.source.includes('Deneme'));
            } else {
                filteredPool = filteredPool.filter(q => q.source === source);
            }

            if (category !== 'TUMU') {
                filteredPool = filteredPool.filter(q => q.category === category);
            }

            if (filteredPool.length === 0) { 
                alert("SeÃ§ilen kriterlere uygun soru bulunamadÄ±!"); 
                return; 
            }

            if ((source === 'KARMA_DENEME' || source === 'KARMA_CIKMIS') && category === 'TUMU') {
                const distribution = STANDARD_DISTRIBUTION;
                for (const [cat, num] of Object.entries(distribution)) {
                    let catQuestions = filteredPool.filter(q => q.category === cat);
                    if (catQuestions.length > 0) {
                        while(catQuestions.length < num) { 
                            catQuestions.push(catQuestions[Math.floor(Math.random() * catQuestions.length)]); 
                        }
                        catQuestions.sort(() => Math.random() - 0.5);
                        currentQuestions.push(...catQuestions.slice(0, num));
                    }
                }
            } else {
                currentQuestions = filteredPool;
            }

            currentQuestions.sort(() => Math.random() - 0.5);

            if (category !== 'TUMU' && currentQuestions.length > 50) {
                currentQuestions = currentQuestions.slice(0, 50);
            }

            userAnswers = {};
            currentIndex = 0;
            if (isTimerActive) startTimer();
            
            history.pushState({ screen: 'quiz' }, null, window.location.pathname);
            renderQuiz();
        }

        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--;
                const el = document.getElementById('timerDisplay');
                if(el) {
                    const m = Math.floor(timeRemaining / 60).toString().padStart(2,'0');
                    const s = (timeRemaining % 60).toString().padStart(2,'0');
                    el.innerText = `${m}:${s}`;
                    if(timeRemaining < 300) el.classList.add('text-red-500', 'animate-pulse');
                }
                if (timeRemaining <= 0) finishQuiz();
            }, 1000);
        }

        function changeFont(delta) {
            fontLevel += delta;
            if (fontLevel < 0) fontLevel = 0;
            if (fontLevel > 3) fontLevel = 3;
            renderQuiz(); 
        }

        // --- SINAV EKRANI ---
        function renderQuiz() {
            currentScreen = 'quiz';
            
            if (!currentQuestions[currentIndex]) {
                console.error("Soru bulunamadÄ±!");
                finishQuiz();
                return;
            }

            setTimeout(() => lucide.createIcons(), 0);
            
            const q = currentQuestions[currentIndex];
            const isAnswered = userAnswers[currentIndex] !== undefined;
            const myAnswer = userAnswers[currentIndex];
            const isBookmarked = favoriteIDs.has(q.text);

            let imageHtml = q.image ? `
                <div class="mb-4 rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 flex justify-center group relative cursor-zoom-in" onclick="openImageModal('${q.image}')">
                    <img src="${q.image}" class="max-h-56 object-contain" onerror="this.style.display='none'">
                    <div class="absolute bottom-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                        <i data-lucide="maximize-2" class="w-3 h-3"></i> BÃ¼yÃ¼t
                    </div>
                </div>` : '';

            let optionsHtml = q.options.map((opt, i) => {
                const letters = ["A", "B", "C", "D", "E"];
                let btnClass = "bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-750 text-slate-700 dark:text-slate-300";
                let iconClass = "bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400";

                if (isAnswered || isReviewMode) {
                    if (!isEduMode && !isReviewMode) { 
                        if (i === myAnswer) { 
                            btnClass = "bg-primary-50 dark:bg-primary-900/20 border-primary-500 ring-1 ring-primary-500 text-primary-900 dark:text-white";
                            iconClass = "bg-primary-600 text-white";
                        }
                    } else { 
                        if (i === q.correct) {
                            btnClass = "bg-green-50 dark:bg-green-900/20 border-green-500 ring-1 ring-green-500 text-green-900 dark:text-white";
                            iconClass = "bg-green-600 text-white";
                        } else if (i === myAnswer) {
                            btnClass = "bg-red-50 dark:bg-red-900/20 border-red-500 ring-1 ring-red-500 text-red-900 dark:text-white";
                            iconClass = "bg-red-600 text-white";
                        }
                    }
                }

                let clickAction = (isEduMode && isAnswered) || isReviewMode ? '' : `onclick="selectAnswer(${i})"`;
                let cursor = ((isEduMode && isAnswered) || isReviewMode) ? 'cursor-default' : 'cursor-pointer';
                let fontClass = `text-size-${fontLevel}`;

                return `
                <div ${clickAction} class="w-full p-3.5 rounded-xl border-2 mb-2.5 flex items-start gap-3 transition-all ${btnClass} ${cursor}">
                    <div class="flex-shrink-0 w-7 h-7 rounded-lg flex items-center justify-center font-bold text-xs border ${iconClass} mt-0.5">
                        ${letters[i]}
                    </div>
                    <span class="${fontClass} font-medium leading-snug pt-1 select-none">${opt}</span>
                </div>`;
            }).join('');

            let explanationHtml = '';
            if ((isEduMode && isAnswered) || isReviewMode) {
                explanationHtml = `
                    <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 rounded-r-xl fade-in">
                        <div class="flex items-center gap-2 mb-1 text-blue-700 dark:text-blue-400 font-bold text-xs uppercase tracking-wider">
                            <i data-lucide="info" class="w-3 h-3"></i> AÃ§Ä±klama
                        </div>
                        <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">${q.explanation || 'AÃ§Ä±klama bulunmuyor.'}</p>
                    </div>
                `;
            }

            const bookmarkClass = isBookmarked ? "text-yellow-500 fill-yellow-500" : "text-slate-300 dark:text-slate-600";
            let titleFontClass = `text-size-${fontLevel+1}`; 

            app.innerHTML = `
                <div class="h-14 px-4 bg-white dark:bg-slate-900 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between shrink-0 z-20">
                    <div class="flex items-center gap-2">
                        <button onclick="if(confirm('Ã‡Ä±kÄ±ÅŸ yapÄ±lsÄ±n mÄ±?')) renderStartScreen()" class="text-slate-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Soru</span>
                            <span class="text-sm font-black text-slate-700 dark:text-slate-200">${currentIndex + 1} <span class="text-slate-300 font-normal">/ ${currentQuestions.length}</span></span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <div class="flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg p-0.5 mr-1">
                            <button onclick="changeFont(-1)" class="p-1.5 hover:bg-white dark:hover:bg-slate-700 rounded text-slate-500"><i data-lucide="minus" class="w-3 h-3"></i></button>
                            <span class="text-xs font-bold text-slate-400 px-1">A</span>
                            <button onclick="changeFont(1)" class="p-1.5 hover:bg-white dark:hover:bg-slate-700 rounded text-slate-500"><i data-lucide="plus" class="w-3 h-3"></i></button>
                        </div>

                        ${isTimerActive ? `<div class="px-2 py-1 bg-slate-100 dark:bg-slate-800 rounded-lg font-mono text-xs font-bold text-slate-600 dark:text-slate-300" id="timerDisplay">--:--</div>` : ''}
                        
                        <button onclick="openReportModal()" class="p-2 hover:bg-red-50 dark:hover:bg-red-900/30 text-slate-400 hover:text-red-500 rounded-full transition-colors" title="Hata Bildir">
                            <i data-lucide="flag" class="w-5 h-5"></i>
                        </button>

                        <button onclick="toggleBookmark()" class="p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-full transition-colors">
                            <i data-lucide="star" class="w-5 h-5 ${bookmarkClass}"></i>
                        </button>
                    </div>
                </div>

                <div id="quizContent" class="flex-1 overflow-y-auto p-5 bg-white dark:bg-slate-900 scroller w-full relative">
                    <div class="max-w-2xl mx-auto fade-in pb-10">
                        <div class="flex gap-2 mb-4">
                            <span class="text-[10px] font-bold px-2 py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-md uppercase tracking-wider border border-indigo-100 dark:border-indigo-800">${q.category}</span>
                            <span class="text-[10px] font-bold px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 rounded-md uppercase tracking-wider border border-slate-200 dark:border-slate-700">${q.source}</span>
                        </div>
                        
                        ${imageHtml}
                        
                        <h2 class="${titleFontClass} font-bold text-slate-800 dark:text-slate-100 mb-6 leading-relaxed select-none">${q.text}</h2>
                        
                        <div>${optionsHtml}</div>
                        ${explanationHtml}
                        
                        <div class="h-8"></div>
                    </div>
                </div>

                <div class="p-3 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 shrink-0 z-30 flex gap-3 pb-safe">
                    <button onclick="prevQ()" ${currentIndex===0?'disabled':''} class="px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 disabled:opacity-30 transition-colors">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    
                    <button onclick="clearAnswer()" class="px-4 py-3 rounded-xl bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-500 font-bold text-xs flex items-center justify-center gap-2 hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors">
                        <i data-lucide="eraser" class="w-4 h-4"></i> <span class="hidden xs:inline">Temizle</span>
                    </button>

                    <button onclick="${currentIndex === currentQuestions.length-1 ? 'finishQuiz()' : 'nextQ()'}" class="flex-1 px-4 py-3 rounded-xl bg-primary-600 hover:bg-primary-700 text-white font-bold text-sm shadow-lg shadow-primary-200 dark:shadow-none flex items-center justify-center gap-2 active:scale-95 transition-transform">
                        ${currentIndex === currentQuestions.length-1 ? 'Bitir' : 'Sonraki'}
                        <i data-lucide="${currentIndex === currentQuestions.length-1 ? 'check-circle' : 'chevron-right'}" class="w-4 h-4"></i>
                    </button>
                </div>
            `;

            const content = document.getElementById('quizContent');
            content.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
            content.addEventListener('touchend', e => {
                let touchEndX = e.changedTouches[0].screenX;
                if (touchEndX < touchStartX - 70) nextQ();
                if (touchEndX > touchStartX + 70) prevQ();
            });
        }

        function selectAnswer(i) {
            if ((isEduMode && userAnswers[currentIndex] !== undefined) || isReviewMode) return;
            userAnswers[currentIndex] = i;
            renderQuiz();
        }

        function toggleBookmark() {
            const qText = currentQuestions[currentIndex].text;
            if (favoriteIDs.has(qText)) {
                favoriteIDs.delete(qText);
            } else {
                favoriteIDs.add(qText);
            }
            localStorage.setItem('isg_favs', JSON.stringify([...favoriteIDs]));
            renderQuiz();
        }

        function clearAnswer() { delete userAnswers[currentIndex]; renderQuiz(); }
        function nextQ() { if(currentIndex < currentQuestions.length-1) { currentIndex++; renderQuiz(); } }
        function prevQ() { if(currentIndex > 0) { currentIndex--; renderQuiz(); } }

        // --- 8. SONUÃ‡ EKRANI ---
        function finishQuiz() {
            currentScreen = 'result';
            if(timerInterval) clearInterval(timerInterval);
            
            // ANALYTICS: SÄ±nav BitiÅŸi
            if (typeof gtag === 'function') {
                gtag('event', 'quiz_completed', {
                    'event_category': 'Engagement',
                    'event_label': activeProfile
                });
            }

            let correct = 0, wrong = 0, empty = 0;
            let topicStats = {};

            currentQuestions.forEach((q, i) => {
                if (!topicStats[q.category]) topicStats[q.category] = { total: 0, correct: 0 };
                topicStats[q.category].total++;

                if (userAnswers[i] === undefined) empty++;
                else if (userAnswers[i] === q.correct) {
                    correct++;
                    topicStats[q.category].correct++;
                }
                else wrong++;
            });

            const score = currentQuestions.length > 0 ? ((correct / currentQuestions.length) * 100).toFixed(1) : 0;
            const profileVal = activeProfile; 
            const profileInfo = CONFIG[profileVal] || CONFIG['igu'];

            if(!isReviewMode && activeProfile !== 'favoriler') {
                const historyData = JSON.parse(localStorage.getItem('examHistory')) || [];
                historyData.unshift({
                    date: new Date().toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit'}),
                    score: score,
                    correct: correct,
                    wrong: wrong,
                    mode: isTimerActive ? 'SÄ±nav' : 'EÄŸitim',
                    profileLabel: profileInfo.label,
                    profileColor: profileInfo.color
                });
                if(historyData.length > 10) historyData.pop();
                localStorage.setItem('examHistory', JSON.stringify(historyData));

                // TOPLAM DOÄžRUYU GÃœNCELLE
                totalCorrectAllTime += correct;
                localStorage.setItem('isg_total_correct', totalCorrectAllTime.toString());
            }

            let analysisHtml = '';
            for (const [cat, data] of Object.entries(topicStats)) {
                const percent = Math.round((data.correct / data.total) * 100);
                let barColor = percent >= 70 ? 'bg-green-500' : (percent >= 40 ? 'bg-yellow-500' : 'bg-red-500');
                
                analysisHtml += `
                    <div class="mb-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-bold text-slate-700 dark:text-slate-300">${cat}</span>
                            <span class="font-mono text-slate-500">${data.correct}/${data.total} (%${percent})</span>
                        </div>
                        <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2">
                            <div class="${barColor} h-2 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }

            app.innerHTML = `
                <div class="flex flex-col h-full bg-white dark:bg-slate-900 overflow-y-auto scroller fade-in">
                    <div class="p-6 flex flex-col items-center justify-center min-h-[35vh] bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-800">
                        <div class="relative mb-4">
                            <svg class="w-32 h-32 transform -rotate-90">
                                <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="8" fill="transparent" class="text-slate-200 dark:text-slate-700" />
                                <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="8" fill="transparent" class="${score >= 70 ? 'text-green-500' : 'text-red-500'} transition-all duration-1000" style="stroke-dasharray: 351.86; stroke-dashoffset: ${351.86 - (351.86 * score / 100)};" />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center flex-col">
                                <span class="text-3xl font-black text-slate-800 dark:text-white">${score}</span>
                                <span class="text-[10px] uppercase font-bold text-slate-400">Puan</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-4 w-full justify-center">
                            <div class="text-center px-4 py-2 bg-white dark:bg-slate-800 rounded-xl border border-green-100 dark:border-green-900/30">
                                <div class="text-lg font-bold text-green-600">${correct}</div>
                                <div class="text-[10px] text-slate-400 uppercase">DoÄŸru</div>
                            </div>
                            <div class="text-center px-4 py-2 bg-white dark:bg-slate-800 rounded-xl border border-red-100 dark:border-red-900/30">
                                <div class="text-lg font-bold text-red-500">${wrong}</div>
                                <div class="text-[10px] text-slate-400 uppercase">YanlÄ±ÅŸ</div>
                            </div>
                            <div class="text-center px-4 py-2 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                                <div class="text-lg font-bold text-slate-500">${empty}</div>
                                <div class="text-[10px] text-slate-400 uppercase">BoÅŸ</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 space-y-4">
                        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl p-4 shadow-sm">
                            <h4 class="text-xs font-bold uppercase text-slate-400 mb-3 flex items-center gap-2"><i data-lucide="pie-chart" class="w-4 h-4"></i> Konu Karnesi</h4>
                            ${analysisHtml}
                        </div>

                        <button onclick="shareResult('${score}', ${correct}, ${wrong})" class="w-full py-3 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-xl font-bold text-sm flex items-center justify-center gap-2">
                            <i data-lucide="share-2" class="w-4 h-4"></i> Sonucu PaylaÅŸ
                        </button>

                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="startReviewMode()" class="w-full py-3.5 bg-white dark:bg-slate-800 border-2 border-red-100 dark:border-red-900/30 text-red-600 dark:text-red-400 rounded-xl font-bold text-sm hover:bg-red-50 dark:hover:bg-red-900/10 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="search" class="w-4 h-4"></i> CevaplarÄ± Ä°ncele
                            </button>
                            
                            <button onclick="renderStartScreen()" class="w-full py-3.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold text-sm shadow-lg hover:translate-y-[-2px] transition-all flex items-center justify-center gap-2">
                                <i data-lucide="home" class="w-4 h-4"></i> Ana MenÃ¼ye DÃ¶n
                            </button>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => lucide.createIcons(), 0);
        }

        function startReviewMode() {
            isReviewMode = true;
            currentIndex = 0;
            renderQuiz();
        }

        window.onload = function() {
            initTheme();
            renderStartScreen();
        };
    </script>
</body>
</html>
