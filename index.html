<!DOCTYPE html>
<html lang="tr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒ∞SG Pro V17 (Akƒ±llƒ±)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {"50":"#eff6ff","100":"#dbeafe","200":"#bfdbfe","300":"#93c5fd","400":"#60a5fa","500":"#3b82f6","600":"#2563eb","700":"#1d4ed8","800":"#1e40af","900":"#1e3a8a"}
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; position: fixed; top: 0; left: 0; right: 0; bottom: 0; height: 100dvh; overflow: hidden; user-select: none; }
        .scroller { -webkit-overflow-scrolling: touch; }
        .scroller::-webkit-scrollbar { width: 3px; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark .scroller::-webkit-scrollbar-thumb { background: #334155; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300">

    <div id="app" class="flex flex-col h-full w-full max-w-md mx-auto bg-white dark:bg-slate-900 shadow-2xl relative transition-colors duration-300 border-x border-slate-200 dark:border-slate-800">
        <div class="flex items-center justify-center h-full">
            <div class="flex flex-col items-center animate-pulse">
                <i data-lucide="loader-2" class="w-10 h-10 text-primary-600 animate-spin mb-3"></i>
                <div class="text-sm font-medium text-slate-400">Sistem Y√ºkleniyor...</div>
            </div>
        </div>
    </div>

    <div id="imageModal" class="fixed inset-0 z-[100] hidden items-center justify-center modal-overlay p-4" onclick="closeImageModal()">
        <div class="relative max-w-4xl w-full max-h-full flex justify-center">
            <button class="absolute -top-10 right-0 text-white hover:text-red-400 p-2" onclick="closeImageModal()">
                <i data-lucide="x" class="w-8 h-8"></i>
            </button>
            <img id="modalImage" src="" class="max-w-full max-h-[85vh] rounded-lg shadow-2xl object-contain bg-white">
        </div>
    </div>

    <script>window.SoruHavuzu = window.SoruHavuzu || [];</script>
    
    <script src="sorular/2025-1-A.js" onerror="console.warn('2025-1-A y√ºklenemedi')"></script>
    <script src="sorular/2025-1-B.js" onerror="console.warn('2025-1-B y√ºklenemedi')"></script>
    <script src="sorular/2025-1-C.js" onerror="console.warn('2025-1-C y√ºklenemedi')"></script>
    <script src="sorular/2025_1C.js" onerror="console.warn('2025_1C y√ºklenemedi')"></script>
    <script src="sorular/deneme_mevzuat.js" onerror="console.warn('Mevzuat y√ºklenemedi')"></script>
    <script src="sorular/deneme_02.js" onerror="console.warn('Deneme 02 y√ºklenemedi')"></script>

    <script>
        // --- 1. G√úVENLƒ∞K ---
        if (window.SoruHavuzu.length === 0) {
            window.SoruHavuzu.push({
                category: "Sistem", text: "Demo Soru: 'sorular' klas√∂r√ºn√º kontrol edin.", options: ["Tamam"], correct: 0, source: "DEMO", explanation: "Dosya bulunamadƒ±.", profile: "ortak"
            });
        }

        // --- 2. AYARLAR ---
        const CONFIG = {
            'isg_a': { label: 'ƒ∞SG (A Sƒ±nƒ±fƒ±)', color: 'red' },
            'isg_b': { label: 'ƒ∞SG (B Sƒ±nƒ±fƒ±)', color: 'orange' },
            'isg_c': { label: 'ƒ∞SG (C Sƒ±nƒ±fƒ±)', color: 'blue' },
            'hekim': { label: 'ƒ∞≈üyeri Hekimliƒüi', color: 'emerald' },
            'dsp': { label: 'Diƒüer Saƒülƒ±k P.', color: 'purple' }
        };

        const STANDARD_DISTRIBUTION = { 'Teknik': 20, 'Mevzuat': 15, 'Genel ƒ∞SG Konularƒ±': 7, 'Saƒülƒ±k': 5, 'Hukuk': 3 };

        let app = document.getElementById('app');
        let currentScreen = 'start';
        let currentQuestions = [];
        let userAnswers = {};
        let bookmarks = new Set();
        let currentIndex = 0;
        let timerInterval;
        let timeRemaining = 0;
        let isTimerActive = true;
        let isEduMode = false;
        let isReviewMode = false;
        let touchStartX = 0;

        // --- 3. TEMEL FONKSƒ∞YONLAR ---
        function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            renderCurrentScreen();
        }
        function renderCurrentScreen() {
            if(currentScreen === 'start') renderStartScreen();
            else if(currentScreen === 'quiz') renderQuiz();
            else if(currentScreen === 'result') finishQuiz();
        }
        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').classList.add('flex');
        }
        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.getElementById('imageModal').classList.remove('flex');
        }

        document.addEventListener('keydown', (e) => {
            if (currentScreen !== 'quiz') return;
            if (e.key >= '1' && e.key <= '5') selectAnswer(parseInt(e.key) - 1);
            if (e.key === 'ArrowRight') nextQ();
            if (e.key === 'ArrowLeft') prevQ();
            if (e.key.toLowerCase() === 'm') toggleBookmark();
            if (e.key === 'Escape') closeImageModal();
        });

        // --- 4. EKRAN: BA≈ûLANGI√á ---
        function renderStartScreen() {
            currentScreen = 'start';
            isReviewMode = false;
            setTimeout(() => { 
                lucide.createIcons();
                updateSourceList(); // Sayfa a√ßƒ±lƒ±nca kaynaklarƒ± filtrele
            }, 0);

            const totalQ = window.SoruHavuzu.length;
            const history = JSON.parse(localStorage.getItem('examHistory')) || [];
            
            const lastExams = history.slice(0, 3).map(h => `
                <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-800 mb-2 text-xs">
                    <div>
                        <div class="font-bold text-slate-700 dark:text-slate-200">${h.date}</div>
                        <div class="text-slate-400 flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full ${h.profileColor ? 'bg-'+h.profileColor+'-500' : 'bg-slate-400'}"></span>
                            ${h.profileLabel || 'Genel'}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold ${h.score >= 70 ? 'text-green-600' : 'text-red-500'} text-lg">${h.score}</div>
                    </div>
                </div>
            `).join('') || '<div class="text-xs text-slate-400 text-center py-4">Hen√ºz sƒ±nav ge√ßmi≈üi yok.</div>';

            const categories = [...new Set(window.SoruHavuzu.map(q => q.category))].sort();
            let catOpts = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            const isDark = document.documentElement.classList.contains('dark');

            app.innerHTML = `
                <div class="flex flex-col h-full bg-white dark:bg-slate-900 transition-colors">
                    <div class="p-5 flex justify-between items-center border-b border-slate-100 dark:border-slate-800">
                        <div>
                            <h1 class="text-2xl font-black text-slate-800 dark:text-white tracking-tight">ƒ∞SG <span class="text-primary-600">PRO</span> <span class="text-xs font-normal text-slate-400 align-top">V17</span></h1>
                        </div>
                        <button onclick="toggleTheme()" class="p-2.5 rounded-full bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 transition-all">
                            <i data-lucide="${isDark ? 'sun' : 'moon'}" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-5 scroller space-y-6">
                        <div class="relative overflow-hidden rounded-xl bg-gradient-to-r from-primary-600 to-primary-800 p-4 text-white shadow-lg shadow-primary-200 dark:shadow-none">
                            <div class="relative z-10 flex justify-between items-end">
                                <div>
                                    <div class="text-primary-100 text-xs font-medium mb-1">Toplam Soru Havuzu</div>
                                    <div class="text-3xl font-black">${totalQ}</div>
                                </div>
                                <div class="p-2 bg-white/10 rounded-lg backdrop-blur-sm">
                                    <i data-lucide="database" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                            <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 rounded-full bg-white/10 blur-xl"></div>
                            <div class="absolute bottom-0 left-0 -mb-4 -ml-4 w-20 h-20 rounded-full bg-white/10 blur-lg"></div>
                        </div>

                        <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4 space-y-4 shadow-sm">
                            <h3 class="text-sm font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                <i data-lucide="settings-2" class="w-4 h-4 text-slate-400"></i> Sƒ±navƒ± Yapƒ±landƒ±r
                            </h3>
                            
                            <div class="grid grid-cols-1 gap-4">
                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Sƒ±nav Grubu</label>
                                    <select id="profileSelect" onchange="updateSourceList()" class="w-full mt-1 p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-bold text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-primary-500 outline-none appearance-none">
                                        <option value="isg_a">üÖ∞Ô∏è ƒ∞SG (A Sƒ±nƒ±fƒ±)</option>
                                        <option value="isg_b">üÖ±Ô∏è ƒ∞SG (B Sƒ±nƒ±fƒ±)</option>
                                        <option value="isg_c" selected>¬©Ô∏è ƒ∞SG (C Sƒ±nƒ±fƒ±)</option>
                                        <option value="hekim">‚öïÔ∏è ƒ∞≈üyeri Hekimliƒüi</option>
                                        <option value="dsp">ü©∫ Diƒüer Saƒülƒ±k P.</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Kaynak Se√ßimi (Akƒ±llƒ± Filtre)</label>
                                    <select id="sourceSelect" class="w-full mt-1 p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-primary-500 outline-none appearance-none">
                                        </select>
                                </div>

                                <div>
                                    <label class="text-[10px] uppercase font-bold text-slate-400 ml-1">Konu Filtresi</label>
                                    <select id="categorySelect" class="w-full mt-1 p-3 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-medium text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-primary-500 outline-none appearance-none">
                                        <option value="TUMU">üìö T√ºm Konular</option>
                                        ${catOpts}
                                    </select>
                                </div>
                            </div>

                            <div class="flex items-center justify-between pt-2 border-t border-slate-100 dark:border-slate-700/50">
                                <div class="flex items-center gap-2">
                                    <div class="p-1.5 bg-indigo-50 dark:bg-indigo-900/30 rounded text-indigo-600 dark:text-indigo-400">
                                        <i data-lucide="graduation-cap" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm font-bold text-slate-700 dark:text-slate-200">Eƒüitim Modu</div>
                                        <div class="text-[10px] text-slate-400">Cevabƒ± anƒ±nda g√∂ster</div>
                                    </div>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="eduToggle" class="sr-only peer">
                                    <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary-600"></div>
                                </label>
                            </div>
                            
                            <button onclick="startCustomQuiz()" class="w-full py-3.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold text-sm shadow-lg hover:shadow-xl hover:translate-y-[-2px] transition-all flex items-center justify-center gap-2">
                                Sƒ±navƒ± Ba≈ülat <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </div>

                        <div>
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-sm font-bold text-slate-900 dark:text-white flex items-center gap-2">
                                    <i data-lucide="history" class="w-4 h-4 text-slate-400"></i> Son Sƒ±navlar
                                </h3>
                                <button onclick="clearHistory()" class="text-[10px] text-red-400 hover:text-red-600 hover:underline">Ge√ßmi≈üi Temizle</button>
                            </div>
                            ${lastExams}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- YENƒ∞ FONKSƒ∞YON: Akƒ±llƒ± Kaynak Listesi ---
        function updateSourceList() {
            const profile = document.getElementById('profileSelect').value;
            const select = document.getElementById('sourceSelect');
            
            // T√ºm benzersiz kaynaklarƒ± bul
            const allSources = [...new Set(window.SoruHavuzu.map(q => q.source))].sort().reverse();
            
            // Profil i√ßin ƒ∞SG grubu kontrol√º
            const isISG = ['isg_a', 'isg_b', 'isg_c'].includes(profile);

            // Kaynaklarƒ± Filtrele
            const filteredSources = allSources.filter(sourceName => {
                // Kaynaktaki ilk soruyu bul (√ñrneklem)
                const sampleQ = window.SoruHavuzu.find(q => q.source === sourceName);
                if (!sampleQ) return false;

                // Kural 1: Ortak sorular (igu, ortak) herkese g√∂r√ºn√ºr
                if (sampleQ.profile === 'ortak' || sampleQ.profile === 'igu') return true;
                
                // Kural 2: Profil tam e≈üle≈üiyorsa g√∂r√ºn√ºr (√∂rn: isg_c se√ßili, soru isg_c)
                if (sampleQ.profile === profile) return true;

                // Kural 3: Eƒüer ƒ∞SG se√ßiliyse ve soru 'igu' ise g√∂r√ºn√ºr (Yukarƒ±da kapsandƒ± ama garanti olsun)
                if (isISG && sampleQ.profile === 'igu') return true;

                // Kural 4: ƒ∞SG A se√ßiliyse, ƒ∞SG B veya C √∂zel sorularƒ± G√ñR√úNMEMELƒ∞. 
                // Buradaki mantƒ±k: Se√ßilen profil ile uyumlu mu?
                return false;
            });

            // HTML Olu≈ütur
            let html = `
                <option value="KARMA_DENEME" class="font-bold text-indigo-600">üé≤ Karma Deneme (50 Soru)</option>
                <option value="KARMA_CIKMIS" class="font-bold text-rose-600">üìÖ Karma √áƒ±kmƒ±≈ü Sorular (50 Soru)</option>
                <option disabled class="text-slate-300">‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
            `;

            filteredSources.forEach(s => {
                html += `<option value="${s}">${s}</option>`;
            });

            if (filteredSources.length === 0) {
                html += `<option disabled>Bu profile uygun kaynak yok</option>`;
            }

            select.innerHTML = html;
        }

        function clearHistory() {
            if(confirm("Sƒ±nav ge√ßmi≈üini silmek istiyor musun?")) {
                localStorage.removeItem('examHistory');
                renderStartScreen();
            }
        }

        // --- 6. SINAV HAZIRLIK (G√úNCELLENDƒ∞) ---
        function startCustomQuiz() {
            const profile = document.getElementById('profileSelect').value;
            const source = document.getElementById('sourceSelect').value;
            const category = document.getElementById('categorySelect').value;
            
            isEduMode = document.getElementById('eduToggle').checked;
            isTimerActive = !isEduMode;
            timeRemaining = 75 * 60;
            
            prepareQuizQuestions(source, profile, category, 50);
        }

        function prepareQuizQuestions(source, profile, category, count) {
            currentQuestions = [];
            let pool = window.SoruHavuzu;
            const isISG = ['isg_a', 'isg_b', 'isg_c'].includes(profile);

            // 1. Profil Filtresi (Bu kullanƒ±cƒ±nƒ±n √ß√∂zebileceƒüi t√ºm sorular)
            let filteredPool = pool.filter(q => {
                if (q.profile === 'ortak' || !q.profile) return true;
                if (q.profile === profile) return true;
                if (isISG && q.profile === 'igu') return true;
                return false;
            });

            // 2. Kaynak Mantƒ±ƒüƒ± (Karma vs Tekil)
            if (source === 'KARMA_DENEME') {
                // Sadece isminde "Deneme" ge√ßen kaynaklardan al
                filteredPool = filteredPool.filter(q => q.source.includes('Deneme'));
            } else if (source === 'KARMA_CIKMIS') {
                // ƒ∞sminde "Deneme" GE√áMEYEN kaynaklardan al (√áƒ±kmƒ±≈ü sorular varsayƒ±mƒ±)
                filteredPool = filteredPool.filter(q => !q.source.includes('Deneme'));
            } else {
                // Belirli bir kaynak se√ßildiyse (√ñrn: 2025-1C)
                filteredPool = filteredPool.filter(q => q.source === source);
            }

            // 3. Konu Filtresi
            if (category !== 'TUMU') {
                filteredPool = filteredPool.filter(q => q.category === category);
            }

            if (filteredPool.length === 0) { 
                alert("Se√ßilen kriterlere uygun soru bulunamadƒ±!"); 
                return; 
            }

            // 4. Daƒüƒ±tƒ±m ve Se√ßim
            if ((source === 'KARMA_DENEME' || source === 'KARMA_CIKMIS') && category === 'TUMU') {
                const distribution = STANDARD_DISTRIBUTION;
                for (const [cat, num] of Object.entries(distribution)) {
                    let catQuestions = filteredPool.filter(q => q.category === cat);
                    if (catQuestions.length > 0) {
                        while(catQuestions.length < num) { 
                            catQuestions.push(catQuestions[Math.floor(Math.random() * catQuestions.length)]); 
                        }
                        catQuestions.sort(() => Math.random() - 0.5);
                        currentQuestions.push(...catQuestions.slice(0, num));
                    }
                }
            } else {
                currentQuestions = filteredPool;
            }

            // Her zaman karƒ±≈ütƒ±r
            currentQuestions.sort(() => Math.random() - 0.5);

            // Limitle
            if (category !== 'TUMU' && currentQuestions.length > 50) {
                currentQuestions = currentQuestions.slice(0, 50);
            }

            userAnswers = {};
            bookmarks = new Set();
            currentIndex = 0;
            if (isTimerActive) startTimer();
            renderQuiz();
        }

        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--;
                const el = document.getElementById('timerDisplay');
                if(el) {
                    const m = Math.floor(timeRemaining / 60).toString().padStart(2,'0');
                    const s = (timeRemaining % 60).toString().padStart(2,'0');
                    el.innerText = `${m}:${s}`;
                    if(timeRemaining < 300) el.classList.add('text-red-500', 'animate-pulse');
                }
                if (timeRemaining <= 0) finishQuiz();
            }, 1000);
        }

        // --- 7. SINAV EKRANI ---
        function renderQuiz() {
            currentScreen = 'quiz';
            setTimeout(() => lucide.createIcons(), 0);
            
            const q = currentQuestions[currentIndex];
            const isAnswered = userAnswers[currentIndex] !== undefined;
            const myAnswer = userAnswers[currentIndex];
            const isBookmarked = bookmarks.has(currentIndex);

            let imageHtml = q.image ? `
                <div class="mb-4 rounded-xl overflow-hidden border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 flex justify-center group relative cursor-zoom-in" onclick="openImageModal('${q.image}')">
                    <img src="${q.image}" class="max-h-56 object-contain" onerror="this.style.display='none'">
                    <div class="absolute bottom-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1">
                        <i data-lucide="maximize-2" class="w-3 h-3"></i> B√ºy√ºt
                    </div>
                </div>` : '';

            let optionsHtml = q.options.map((opt, i) => {
                const letters = ["A", "B", "C", "D", "E"];
                let btnClass = "bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-750 text-slate-700 dark:text-slate-300";
                let iconClass = "bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400";

                if (isAnswered || isReviewMode) {
                    if (!isEduMode && !isReviewMode) { 
                        if (i === myAnswer) { 
                            btnClass = "bg-primary-50 dark:bg-primary-900/20 border-primary-500 ring-1 ring-primary-500 text-primary-900 dark:text-white";
                            iconClass = "bg-primary-600 text-white";
                        }
                    } else { 
                        if (i === q.correct) {
                            btnClass = "bg-green-50 dark:bg-green-900/20 border-green-500 ring-1 ring-green-500 text-green-900 dark:text-white";
                            iconClass = "bg-green-600 text-white";
                        } else if (i === myAnswer) {
                            btnClass = "bg-red-50 dark:bg-red-900/20 border-red-500 ring-1 ring-red-500 text-red-900 dark:text-white";
                            iconClass = "bg-red-600 text-white";
                        }
                    }
                }

                let clickAction = (isEduMode && isAnswered) || isReviewMode ? '' : `onclick="selectAnswer(${i})"`;
                let cursor = ((isEduMode && isAnswered) || isReviewMode) ? 'cursor-default' : 'cursor-pointer';

                return `
                <div ${clickAction} class="w-full p-3.5 rounded-xl border-2 mb-2.5 flex items-start gap-3 transition-all ${btnClass} ${cursor}">
                    <div class="flex-shrink-0 w-7 h-7 rounded-lg flex items-center justify-center font-bold text-xs border ${iconClass} mt-0.5">
                        ${letters[i]}
                    </div>
                    <span class="text-sm font-medium leading-snug pt-1">${opt}</span>
                </div>`;
            }).join('');

            let explanationHtml = '';
            if ((isEduMode && isAnswered) || isReviewMode) {
                explanationHtml = `
                    <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 rounded-r-xl fade-in">
                        <div class="flex items-center gap-2 mb-1 text-blue-700 dark:text-blue-400 font-bold text-xs uppercase tracking-wider">
                            <i data-lucide="info" class="w-3 h-3"></i> A√ßƒ±klama
                        </div>
                        <p class="text-sm text-slate-700 dark:text-slate-300 leading-relaxed">${q.explanation || 'A√ßƒ±klama bulunmuyor.'}</p>
                    </div>
                `;
            }

            const bookmarkClass = isBookmarked ? "text-yellow-500 fill-yellow-500" : "text-slate-300 dark:text-slate-600";

            app.innerHTML = `
                <div class="h-14 px-4 bg-white dark:bg-slate-900 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between shrink-0 z-20">
                    <div class="flex items-center gap-3">
                        <button onclick="if(confirm('√áƒ±kƒ±≈ü yapƒ±lsƒ±n mƒ±?')) renderStartScreen()" class="text-slate-400 hover:text-red-500 transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Soru</span>
                            <span class="text-sm font-black text-slate-700 dark:text-slate-200">${currentIndex + 1} <span class="text-slate-300 font-normal">/ ${currentQuestions.length}</span></span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        ${isTimerActive ? `<div class="px-3 py-1 bg-slate-100 dark:bg-slate-800 rounded-lg font-mono text-sm font-bold text-slate-600 dark:text-slate-300" id="timerDisplay">--:--</div>` : ''}
                        <button onclick="toggleBookmark()" class="p-2 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-full transition-colors">
                            <i data-lucide="bookmark" class="w-5 h-5 ${bookmarkClass}"></i>
                        </button>
                    </div>
                </div>

                <div id="quizContent" class="flex-1 overflow-y-auto p-5 bg-white dark:bg-slate-900 scroller w-full relative">
                    <div class="max-w-2xl mx-auto fade-in pb-10">
                        <div class="flex gap-2 mb-4">
                            <span class="text-[10px] font-bold px-2 py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 rounded-md uppercase tracking-wider border border-indigo-100 dark:border-indigo-800">${q.category}</span>
                            <span class="text-[10px] font-bold px-2 py-1 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 rounded-md uppercase tracking-wider border border-slate-200 dark:border-slate-700">${q.source}</span>
                        </div>
                        
                        ${imageHtml}
                        
                        <h2 class="text-lg font-bold text-slate-800 dark:text-slate-100 mb-6 leading-relaxed">${q.text}</h2>
                        
                        <div>${optionsHtml}</div>
                        ${explanationHtml}
                        
                        <div class="h-8"></div>
                    </div>
                </div>

                <div class="p-3 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 shrink-0 z-30 flex gap-3 pb-safe">
                    <button onclick="prevQ()" ${currentIndex===0?'disabled':''} class="px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 disabled:opacity-30 transition-colors">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    
                    <button onclick="clearAnswer()" class="px-4 py-3 rounded-xl bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-500 font-bold text-xs flex items-center justify-center gap-2 hover:bg-amber-100 dark:hover:bg-amber-900/30 transition-colors">
                        <i data-lucide="eraser" class="w-4 h-4"></i> <span class="hidden xs:inline">Temizle</span>
                    </button>

                    <button onclick="${currentIndex === currentQuestions.length-1 ? 'finishQuiz()' : 'nextQ()'}" class="flex-1 px-4 py-3 rounded-xl bg-primary-600 hover:bg-primary-700 text-white font-bold text-sm shadow-lg shadow-primary-200 dark:shadow-none flex items-center justify-center gap-2 active:scale-95 transition-transform">
                        ${currentIndex === currentQuestions.length-1 ? 'Bitir' : 'Sonraki'}
                        <i data-lucide="${currentIndex === currentQuestions.length-1 ? 'check-circle' : 'chevron-right'}" class="w-4 h-4"></i>
                    </button>
                </div>
            `;

            const content = document.getElementById('quizContent');
            content.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
            content.addEventListener('touchend', e => {
                let touchEndX = e.changedTouches[0].screenX;
                if (touchEndX < touchStartX - 70) nextQ();
                if (touchEndX > touchStartX + 70) prevQ();
            });
        }

        function selectAnswer(i) {
            if ((isEduMode && userAnswers[currentIndex] !== undefined) || isReviewMode) return;
            userAnswers[currentIndex] = i;
            renderQuiz();
        }

        function toggleBookmark() {
            if (bookmarks.has(currentIndex)) bookmarks.delete(currentIndex);
            else bookmarks.add(currentIndex);
            renderQuiz();
        }

        function clearAnswer() { delete userAnswers[currentIndex]; renderQuiz(); }
        function nextQ() { if(currentIndex < currentQuestions.length-1) { currentIndex++; renderQuiz(); } }
        function prevQ() { if(currentIndex > 0) { currentIndex--; renderQuiz(); } }

        // --- 8. SONU√á EKRANI ---
        function finishQuiz() {
            currentScreen = 'result';
            if(timerInterval) clearInterval(timerInterval);
            
            let correct = 0, wrong = 0, empty = 0;
            currentQuestions.forEach((q, i) => {
                if (userAnswers[i] === undefined) empty++;
                else if (userAnswers[i] === q.correct) correct++;
                else wrong++;
            });

            const score = ((correct / currentQuestions.length) * 100).toFixed(1);
            const profileVal = document.getElementById('profileSelect') ? document.getElementById('profileSelect').value : 'igu';
            const profileInfo = CONFIG[profileVal] || CONFIG['igu'];

            if(!isReviewMode) {
                const history = JSON.parse(localStorage.getItem('examHistory')) || [];
                history.unshift({
                    date: new Date().toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', hour:'2-digit', minute:'2-digit'}),
                    score: score,
                    correct: correct,
                    wrong: wrong,
                    mode: isTimerActive ? 'Sƒ±nav' : 'Eƒüitim',
                    profileLabel: profileInfo.label,
                    profileColor: profileInfo.color
                });
                if(history.length > 10) history.pop();
                localStorage.setItem('examHistory', JSON.stringify(history));
            }

            app.innerHTML = `
                <div class="flex flex-col h-full bg-white dark:bg-slate-900 overflow-y-auto scroller fade-in">
                    <div class="p-6 flex flex-col items-center justify-center min-h-[40vh] bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-800">
                        <div class="relative mb-4">
                            <svg class="w-32 h-32 transform -rotate-90">
                                <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="8" fill="transparent" class="text-slate-200 dark:text-slate-700" />
                                <circle cx="64" cy="64" r="56" stroke="currentColor" stroke-width="8" fill="transparent" class="${score >= 70 ? 'text-green-500' : 'text-red-500'} transition-all duration-1000" style="stroke-dasharray: 351.86; stroke-dashoffset: ${351.86 - (351.86 * score / 100)};" />
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center flex-col">
                                <span class="text-3xl font-black text-slate-800 dark:text-white">${score}</span>
                                <span class="text-[10px] uppercase font-bold text-slate-400">Puan</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-4 w-full justify-center">
                            <div class="text-center px-4 py-2 bg-white dark:bg-slate-800 rounded-xl border border-green-100 dark:border-green-900/30">
                                <div class="text-lg font-bold text-green-600">${correct}</div>
                                <div class="text-[10px] text-slate-400 uppercase">Doƒüru</div>
                            </div>
                            <div class="text-center px-4 py-2 bg-white dark:bg-slate-800 rounded-xl border border-red-100 dark:border-red-900/30">
                                <div class="text-lg font-bold text-red-500">${wrong}</div>
                                <div class="text-[10px] text-slate-400 uppercase">Yanlƒ±≈ü</div>
                            </div>
                            <div class="text-center px-4 py-2 bg-white dark:bg-slate-800 rounded-xl border border-slate-100 dark:border-slate-700">
                                <div class="text-lg font-bold text-slate-500">${empty}</div>
                                <div class="text-[10px] text-slate-400 uppercase">Bo≈ü</div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 space-y-4">
                        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 text-center">
                            <div class="text-xs text-blue-600 dark:text-blue-300 font-bold uppercase mb-1">Sƒ±nav Grubu</div>
                            <div class="font-black text-slate-800 dark:text-white">${profileInfo.label}</div>
                        </div>

                        <div class="grid grid-cols-1 gap-3">
                            <button onclick="startReviewMode()" class="w-full py-3.5 bg-white dark:bg-slate-800 border-2 border-red-100 dark:border-red-900/30 text-red-600 dark:text-red-400 rounded-xl font-bold text-sm hover:bg-red-50 dark:hover:bg-red-900/10 transition-all flex items-center justify-center gap-2">
                                <i data-lucide="search" class="w-4 h-4"></i> Cevaplarƒ± ƒ∞ncele
                            </button>
                            
                            <button onclick="renderStartScreen()" class="w-full py-3.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-xl font-bold text-sm shadow-lg hover:translate-y-[-2px] transition-all flex items-center justify-center gap-2">
                                <i data-lucide="home" class="w-4 h-4"></i> Ana Men√ºye D√∂n
                            </button>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => lucide.createIcons(), 0);
        }

        function startReviewMode() {
            isReviewMode = true;
            currentIndex = 0;
            renderQuiz();
        }

        window.onload = function() {
            initTheme();
            renderStartScreen();
        };
    </script>
</body>
</html>
